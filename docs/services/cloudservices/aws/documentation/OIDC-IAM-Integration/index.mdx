---
sidebar_position: 2
title: "Setting Up OIDC for GitHub Actions with AWS"
description: "Secure GitHub Actions authentication using OpenID Connect"
tags: [CIROH, GitHub Actions, AWS, OIDC, Security, CI/CD]
---

import useBaseUrl from '@docusaurus/useBaseUrl'

OpenID Connect (OIDC) allows GitHub Actions to authenticate with AWS without storing long-lived credentials. This guide walks through setting up OIDC authentication for your GitHub Actions workflows.

## Benefits of OIDC

- **No long-lived credentials**: Eliminates the need to store AWS access keys in GitHub secrets
- **Automatic credential rotation**: Temporary credentials are generated for each workflow run
- **Enhanced security**: Fine-grained control over which repositories can access AWS resources
- **Audit trail**: Clear CloudTrail logs showing which workflows assumed roles

## Step 1: Create the OIDC Identity Provider

Navigate to IAM and select Identity Providers to add a new OpenID Connect provider. Enter the GitHub Actions token URL (`https://token.actions.githubusercontent.com`) as the provider URL and specify `sts.amazonaws.com` as the audience. This establishes the trust relationship between AWS and GitHub Actions for secure authentication.

<p align="center">
<img src={useBaseUrl("/img/oidc-create-provider.png")} alt="Creating OIDC Identity Provider" style={{'width':'80%', 'height':'80%'}}/>
</p>

After creating the identity provider, you'll see it listed in your IAM console with the provider URL `token.actions.githubusercontent.com`. The provider details show the ARN, creation time, and configured audience (`sts.amazonaws.com`) that will be used for authentication.

<p align="center">
<img src={useBaseUrl("/img/oidc-provider-details.png")} alt="OIDC Provider Details" style={{'width':'80%', 'height':'80%'}}/>
</p>

## Step 2: Create IAM Role with Custom Trust Policy

When creating a new IAM role, select "Custom trust policy" as the trusted entity type. The trust policy defines the conditions under which GitHub Actions can assume this role, including the Federated principal (your OIDC provider ARN) and the repository filter using StringLike condition.

<p align="center">
<img src={useBaseUrl("/img/oidc-custom-trust-policy.png")} alt="Creating IAM Role with Custom Trust Policy" style={{'width':'80%', 'height':'80%'}}/>
</p>

### Custom Trust Policy

Replace `ACCOUNT_ID` with your AWS account ID and `ORG_NAME/REPO_NAME` with your GitHub organization and repository name:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Federated": "arn:aws:iam::ACCOUNT_ID:oidc-provider/token.actions.githubusercontent.com"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringEquals": {
                    "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
                },
                "StringLike": {
                    "token.actions.githubusercontent.com:sub": "repo:ORG_NAME/REPO_NAME:*"
                }
            }
        }
    ]
}
```

## Step 3: Create Permissions Policy

Create a custom IAM policy that defines the specific AWS permissions your GitHub Actions workflow needs. This policy includes permissions for Terraform state management (S3, DynamoDB), infrastructure deployment (Lambda, Step Functions, EC2), and resource monitoring (CloudWatch Logs).

<p align="center">
<img src={useBaseUrl("/img/oidc-permissions-policy.png")} alt="Creating Permissions Policy" style={{'width':'80%', 'height':'80%'}}/>
</p>

The JSON policy editor allows you to specify granular permissions for each AWS service your workflow will interact with. Refer to your infrastructure requirements to determine the necessary permissions.

## Step 4: Attach Policy to Role

In the role creation wizard, search for and select your custom policy (e.g., `GitHubActions-NgenDatastream-Policy`) to attach it to the role. This step links the permissions you defined earlier with the trust relationship configured in the trust policy.

<p align="center">
<img src={useBaseUrl("/img/oidc-attach-policy.png")} alt="Attaching Policy to Role" style={{'width':'80%', 'height':'80%'}}/>
</p>

Multiple policies can be attached to a single role if your workflow requires permissions from different policy documents.

## Step 5: Name and Create the Role

Provide a descriptive name for your IAM role (e.g., `github-actions-ngen-datastream-role`) and review the complete trust policy configuration. The trust policy shows the OIDC provider ARN, the required audience (`sts.amazonaws.com`), and the repository condition that restricts access to your specific GitHub repository.

<p align="center">
<img src={useBaseUrl("/img/oidc-name-role.png")} alt="Naming and Creating the Role" style={{'width':'80%', 'height':'80%'}}/>
</p>

After verification, create the role to finalize the OIDC setup.

## Step 6: Add Role ARN to GitHub Secrets

In your GitHub repository settings, navigate to **Settings** → **Secrets and variables** → **Actions** and add a new repository secret. Create a secret named `AWS_ROLE_ARN` with the complete ARN of the IAM role you just created.

<p align="center">
<img src={useBaseUrl("/img/oidc-github-secret.png")} alt="Adding Role ARN to GitHub Secrets" style={{'width':'80%', 'height':'80%'}}/>
</p>

This secret will be referenced in your workflow file to authenticate with AWS using OIDC instead of long-lived access keys.

## Step 7: Use OIDC in Your Workflow

Add the following step to your GitHub Actions workflow to authenticate with AWS using OIDC:

```yaml
- name: Configure AWS Credentials (OIDC)
  uses: aws-actions/configure-aws-credentials@v4
  with:
    role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
    aws-region: ${{ env.AWS_REGION }}
    role-session-name: GitHubActions-TerraformCheck
```

### How It Works

**Initiates OIDC Authentication**

This step uses the official AWS GitHub Action to authenticate with AWS using OpenID Connect instead of traditional access keys. GitHub automatically generates a short-lived JSON Web Token (JWT) that contains information about your workflow, repository, and branch.

**Assumes the IAM Role**

The action sends the JWT to AWS STS (Security Token Service) and requests to assume the IAM role specified in `role-to-assume`. AWS validates the token against your OIDC provider's trust policy, checking that the request comes from your authorized repository.

**Provides Temporary Credentials**

Once validated, AWS returns temporary security credentials (access key, secret key, and session token) that are valid for the duration of the workflow job. These credentials are automatically configured in the GitHub Actions environment, making them available to all subsequent steps that use the AWS CLI or SDKs.

### Key Parameters

- **`role-to-assume`**: The ARN of your IAM role stored as a GitHub secret
- **`aws-region`**: The AWS region for the session
- **`role-session-name`**: A descriptive identifier for CloudTrail logging and auditing (helps you track which job assumed the role)

## Required Workflow Permissions

Ensure your workflow job has the necessary permissions to request OIDC tokens:

```yaml
permissions:
  id-token: write
  contents: read
```

## Complete Workflow Example

Here's a complete example of a GitHub Actions workflow using OIDC authentication:

```yaml
name: Deploy Infrastructure

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-2

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Deploy
      
      - name: Verify AWS Identity
        run: aws sts get-caller-identity
```

## Security Best Practices

1. **Limit repository access**: Use specific repository names in the trust policy rather than wildcards
2. **Use least privilege**: Only grant the permissions your workflow actually needs
3. **Set session names**: Use descriptive `role-session-name` values for better audit trails
4. **Monitor role usage**: Regularly review CloudTrail logs to detect unauthorized access attempts
5. **Rotate OIDC thumbprints**: Keep the OIDC provider thumbprints updated if GitHub rotates their signing keys

## Troubleshooting

**Error: "Not authorized to perform sts:AssumeRoleWithWebIdentity"**
- Verify the trust policy includes your correct repository name
- Ensure the OIDC provider ARN matches in both the trust policy and your AWS account

**Error: "Token audience validation failed"**
- Check that the audience in the trust policy is exactly `sts.amazonaws.com`
- Verify the OIDC provider configuration has the correct audience

**Permissions denied during workflow execution**
- Review the IAM policy attached to the role and ensure it includes all necessary permissions
- Check for resource-specific ARN restrictions that might be blocking access